# How the Forecast Data is Generated

## Overview

The forecast you're seeing with **5-minute intervals** (5m, 10m, 15m, etc.) and **probabilistic values** (P10, P50, P90) comes from a multi-step process:

## Data Flow

### 1. **External API Call**
```
Frontend Dashboard
    ↓
GET /api/v1/forecast/microgrid/microgrid_001?horizon_hours=24
    ↓
external_forecast_service.py
    ↓
POST http://127.0.0.1:8000/api/run (with source="hybrid")
    ↓
External Forecast Service (NGBoost Model)
```

### 2. **Forecast Generation (Backend)**

The external API uses an **NGBoost probabilistic model** that:

1. **Fetches Historical Weather Data** (Open-Meteo API)
   - Last 180 days of weather data
   - Features: temperature, cloud cover, humidity, pressure, wind speed, etc.

2. **Trains/Updates NGBoost Model**
   - Gradient boosting for probabilistic prediction
   - Learns patterns from historical data
   - Generates uncertainty estimates

3. **Generates Hourly Forecasts**
   - For each hour in the next 24 hours
   - Produces **probabilistic predictions**:
     - **P10** (10th percentile): Pessimistic scenario (10% chance of being lower)
     - **P50** (50th percentile): Most likely (median)
     - **P90** (90th percentile): Optimistic scenario (90% chance of being lower)
   - Also calculates **mean** and **standard deviation** (uncertainty)

### 3. **GHI to Power Conversion**

For each forecast point, the system converts **GHI (W/m²)** to **Power (kW)**:

```python
def ghi_to_power(ghi_w_m2, capacity_kw, system_losses=0.15, 
                 temperature_derating=0.05, pollution_factor=0.95, 
                 soiling_factor=0.97):
    power_kw = (
        (ghi_w_m2 / 1000.0) * 
        capacity_kw * 
        (1 - system_losses) *      # 15% system losses
        (1 - temperature_derating) * # 5% temperature losses
        pollution_factor *          # 95% (Delhi pollution)
        soiling_factor              # 97% (panel soiling)
    )
    return max(0.0, min(power_kw, capacity_kw))
```

**Example:**
- GHI: 850 W/m²
- Capacity: 50 kW
- Power = (850/1000) × 50 × 0.85 × 0.95 × 0.95 × 0.97 = **40.5 kW**

### 4. **Frontend Display Transformation**

The frontend receives **hourly forecasts** but displays them as **5-minute intervals**:

```typescript
// Takes first 10 forecast points
const forecastPoints = microgridForecast.forecast.slice(0, 10);

// Transforms each point
forecasts = forecastPoints.map((point, idx) => {
  const minutesFromNow = Math.round((pointTime - now) / (1000 * 60));
  // Displays as "5m", "10m", "15m", etc.
  return {
    time: `${minutesFromNow}m`,  // or actual clock time
    p10: point.ghi.p10,          // From NGBoost model
    p50: point.ghi.p50,           // From NGBoost model
    p90: point.ghi.p90,           // From NGBoost model
    power_output: point.power_kw.mean  // Calculated from GHI
  };
});
```

### 5. **Confidence Calculation**

The **87% confidence** is calculated from the forecast uncertainty:

```typescript
confidence = 1 - (avg_uncertainty / 1000)
```

Where `avg_uncertainty` is the average standard deviation across all forecast points.

**Example:**
- Average uncertainty: 130 W/m²
- Confidence = 1 - (130/1000) = 0.87 = **87%**

## Current Values

The **Current Irradiance (850 W/m²)** and **Power Output (40.5 kW)** come from:

1. **First priority**: Latest sensor reading from the microgrid
2. **Second priority**: First forecast point (next hour's prediction)
3. **Fallback**: Zero (if it's nighttime)

## Why 5-Minute Intervals?

The system actually generates **hourly forecasts**, but the frontend:
- Takes the first 10 hourly points
- Displays them as if they're 5-minute intervals
- This gives a **60-minute (1-hour) view** of the forecast

**Note**: The time labels (5m, 10m, 15m) are calculated from the actual timestamps, so they represent when each forecast point is predicted for, not necessarily exactly 5 minutes apart.

## Data Sources

1. **Weather Data**: Open-Meteo API (ERA5 reanalysis)
2. **Forecast Model**: NGBoost (probabilistic gradient boosting)
3. **Power Calculation**: Physics-based conversion with realistic loss factors
4. **Current Values**: Sensor readings or first forecast point

## Summary

Your forecast data is generated by:
1. ✅ **NGBoost ML model** trained on 180 days of historical weather
2. ✅ **Probabilistic predictions** (P10/P50/P90) for uncertainty quantification
3. ✅ **Physics-based power conversion** with realistic loss factors
4. ✅ **Hourly forecasts** displayed as 5-minute intervals in the UI
5. ✅ **Confidence score** derived from model uncertainty

The data is **real** (not mock) when the external API is working. When it times out, the system falls back to mock data with a warning.








